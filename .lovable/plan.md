

# خطة: تعديل منطق التسعير - السعر المدخل هو النهائي بعد الخصم

## الملخص
تغيير منطق حساب الأسعار بحيث يكون السعر المدخل هو السعر السنوي النهائي (بعد الخصم)، والنظام يحسب تلقائيا السعر الأصلي قبل الخصم والسعر الشهري.

---

## المنطق الجديد

```text
المدخلات:
  - السعر السنوي بعد الخصم (ما يدفعه العميل) = 600
  - نسبة الخصم السنوي = 10%

الحسابات التلقائية:
  1. السعر الأصلي = 600 / (1 - 0.10) = 666.67
  2. السعر الشهري = 666.67 / 12 = 55.56

القواعد:
  - السعر الشهري يُحسب دائما من السعر الأصلي (قبل الخصم)
  - الخصم يطبق على السنوي فقط
  - الشهري لا يحتوي على خصومات
```

---

## التغييرات المطلوبة

### 1. تعديل نموذج الخطة (Plan Modal)

**الحقول:**
- اسم الخطة + الوصف
- السعر السنوي النهائي (بعد الخصم) - حقل واحد فقط
- تفعيل الخصم السنوي (Switch) + نسبة الخصم %
- تفعيل الاشتراك الشهري (Switch)
- المميزات + حالة الخطة

**عرض توضيحي (قراءة فقط) عند تفعيل الخصم:**
- السعر الأصلي قبل الخصم (محسوب)
- نسبة الخصم
- السعر النهائي بعد الخصم (المدخل)

**عرض توضيحي عند تفعيل الشهري:**
- السعر الشهري المحسوب (من السعر الأصلي / 12)

### 2. تعديل دالة الحفظ

```text
عند الحفظ:
  - yearly_price = القيمة المدخلة (بعد الخصم)
  - إذا الخصم مفعل:
      السعر الأصلي = yearly_price / (1 - discount/100)
  - وإلا:
      السعر الأصلي = yearly_price
  - monthly_price = السعر الأصلي / 12 (إذا الشهري مفعل)
  - monthly_price = 0 (إذا الشهري معطل)
```

### 3. تعديل جدول عرض الخطط

إضافة عمود "السعر الأصلي" يعرض السعر قبل الخصم عند وجود خصم.

### 4. تعديل PlanSelector.tsx

- إخفاء خيار "شهري" إذا الخطة لا تدعمه (monthly_price = 0)
- عرض السعر الأصلي مشطوب بجانب السعر المخصوم في الاشتراك السنوي

---

## التفاصيل التقنية

### لا حاجة لتعديل قاعدة البيانات
الأعمدة الحالية كافية: `yearly_price`, `monthly_price`, `yearly_discount`

### الملفات المتأثرة

1. **`src/pages/admin/PricingSettingsPage.tsx`**
   - تعديل `handleSavePlan` لتطبيق المعادلة الجديدة
   - تعديل `openPlanModal` لعكس القيم بشكل صحيح
   - إضافة عرض توضيحي للسعر الأصلي والشهري (قراءة فقط)
   - تحديث جدول الخطط لعرض السعر الأصلي

2. **`src/components/crm/quotes/PlanSelector.tsx`**
   - إخفاء خيار الشهري للخطط غير المدعومة
   - عرض السعر الأصلي مشطوب عند وجود خصم سنوي
   - التحويل التلقائي لسنوي عند اختيار خطة بدون شهري

### منطق الحسابات في الكود

```typescript
// في النموذج (عرض توضيحي فقط)
const yearlyPrice = parseFloat(planForm.yearly_price) || 0;
const discount = planForm.annual_discount_enabled 
  ? (parseInt(planForm.yearly_discount) || 0) : 0;
const originalPrice = discount > 0 
  ? +(yearlyPrice / (1 - discount / 100)).toFixed(2) : yearlyPrice;
const monthlyPrice = +(originalPrice / 12).toFixed(2);

// عند الحفظ
savePlanMutation.mutate({
  yearly_price: yearlyPrice,
  monthly_price: planForm.monthly_enabled ? monthlyPrice : 0,
  yearly_discount: discount,
  ...
});
```

### تخطيط النموذج

```text
+-------------------------------------------+
| [تنبيه: جميع الحسابات تتم تلقائيا]       |
+-------------------------------------------+
| اسم الخطة          |    الوصف             |
+-------------------------------------------+
| السعر السنوي النهائي (بعد الخصم)          |
+-------------------------------------------+
| [x] خصم سنوي [10%] | [x] اشتراك شهري    |
| الأصلي: 666.67 ر.س  | الشهري: 55.56 ر.س   |
| الخصم: -66.67 ر.س   |                     |
+-------------------------------------------+
| المميزات (سطر لكل ميزة)  | [x] نشطة      |
+-------------------------------------------+
|               إلغاء  |  حفظ               |
+-------------------------------------------+
```

