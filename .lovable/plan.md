

# فصل نماذج التضمين: تذاكر الدعم والمراسلات

## الوضع الحالي

- جدول `embed_tokens` واحد يخدم كلا النوعين (تذاكر + دردشة) بدون تمييز بينهما
- صفحة `EmbedSettingsPage` (تذاكر) موجودة في قسم "العملاء (قديم)" في القائمة الجانبية
- صفحة `ChatEmbedSettingsPage` (دردشة) موجودة في قسم "المحادثات"
- لا يوجد ربط بين رموز التضمين وملف العميل (CustomerProfilePage)

## الحل

### 1. اضافة عمود `token_type` لجدول `embed_tokens`

اضافة عمود جديد يميز نوع الرمز:
- `ticket` -- نموذج تذاكر الدعم
- `chat` -- نموذج المراسلات/الدردشة

القيمة الافتراضية `ticket` لضمان توافق الرموز الحالية.

### 2. نقل "تضمين تذاكر الدعم" الى قسم تذاكر الدعم في القائمة الجانبية

نقل الرابط من قسم "العملاء (قديم)" الى قسم "تذاكر الدعم" ليصبح:
- جميع التذاكر
- اعدادات التصعيد
- البلاغات
- **تضمين تذاكر الدعم** (جديد هنا)

### 3. فلترة كل صفحة حسب النوع

- `EmbedSettingsPage` يعرض فقط الرموز من نوع `ticket`
- `ChatEmbedSettingsPage` يعرض فقط الرموز من نوع `chat`
- عند انشاء رمز جديد يتم حفظ النوع المناسب تلقائيا

### 4. اضافة تبويب "التضمين" في ملف العميل (CustomerProfilePage)

تبويب جديد "التضمين" يعرض:
- جميع رموز التضمين المرتبطة بالعميل (تذاكر + دردشة)
- امكانية انشاء رمز تذاكر جديد او رمز دردشة جديد مباشرة من ملف العميل
- عرض حالة كل رمز (فعال/معطل) مع احصائيات الاستخدام
- نسخ كود التضمين مباشرة

---

## التفاصيل التقنية

### قاعدة البيانات

```text
ALTER TABLE embed_tokens ADD COLUMN token_type TEXT DEFAULT 'ticket';
-- تحديث الرموز الحالية التي تبدا بـ chat_ لتصبح من نوع chat
UPDATE embed_tokens SET token_type = 'chat' WHERE token LIKE 'chat_%';
```

### الملفات المتاثرة

| الملف | التغيير |
|-------|---------|
| `src/pages/admin/AdminLayout.tsx` | نقل رابط التضمين من قسم العملاء الى قسم التذاكر |
| `src/pages/admin/EmbedSettingsPage.tsx` | فلترة بـ `token_type = 'ticket'` وحفظ النوع عند الانشاء |
| `src/pages/admin/ChatEmbedSettingsPage.tsx` | فلترة بـ `token_type = 'chat'` وحفظ النوع عند الانشاء |
| `src/pages/admin/crm/CustomerProfilePage.tsx` | اضافة تبويب "التضمين" |
| `src/components/crm/tabs/EmbedTokensTab.tsx` | **جديد** -- مكون التبويب لعرض وانشاء رموز التضمين في ملف العميل |

### مكون `EmbedTokensTab.tsx`

- يستقبل `organizationId` و `organizationName`
- يجلب رموز التضمين المرتبطة بالعميل من `embed_tokens`
- يعرضها مقسمة: قسم "تذاكر الدعم" وقسم "المراسلات"
- زر انشاء رمز جديد مع اختيار النوع (تذكرة/دردشة)
- نسخ كود التضمين (iframe / floating button) مباشرة
- تفعيل/تعطيل/حذف الرموز

