
# ุฎุทุฉ ุชุทููุฑ ูุธุงู ุทูุจ ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ

## ูุธุฑุฉ ุนุงูุฉ
ุชุทููุฑ ูุธุงู ูุชูุงูู ูุทูุจ ุฅุตุฏุงุฑ ููุงุชูุฑ ูู ุนุฑูุถ ุงูุฃุณุนุงุฑ ุงููุนุชูุฏุฉุ ูุน ุฅุฑุณุงู ุจุฑูุฏ ุงุญุชุฑุงูู ููุณุคูู ุงูุญุณุงุจุงุช ูุชุถูู ุฌููุน ุงูุจูุงูุงุช ุงููุงุฒูุฉ ููููุชุฑุฉ.

---

## ุงููุชุทูุจุงุช ุงููุธูููุฉ

### 1. ุฒุฑ ุทูุจ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ
- ูุธูุฑ ููุท ุนูุฏูุง ูููู ุนุฑุถ ุงูุณุนุฑ ุจุญุงูุฉ **ูุนุชูุฏ (accepted)** ุฃู **ูุฑุณู (sent)**
- ููุชุญ ูููุฐุฌ ูุชุฃููุฏ/ุงุณุชููุงู ุจูุงูุงุช ุงููุงุชูุฑุฉ

### 2. ุจูุงูุงุช ูููุฐุฌ ุงูุทูุจ
- **ุจูุงูุงุช ุงูุนููู**: ุงูุงุณูุ ุฑูู ุงูุณุฌูุ ุงูุฑูู ุงูุถุฑูุจูุ ุฌูุฉ ุงูุงุชุตุงู
- **ุงูุนููุงู ุงููุทูู**: ุงููุฏููุฉุ ุงูุญูุ ุงูุดุงุฑุนุ ุฑูู ุงููุจููุ ุงูุฑูุฒ ุงูุจุฑูุฏูุ ุงูุฑูู ุงูุฅุถุงูู
- **ุจูุงูุงุช ุงููุงุชูุฑุฉ**: ุฑูู ุงูุนุฑุถุ ุงูุชุงุฑูุฎุ ุงููุตูุ ุงููุจุงูุบุ ุงูุฎุตูุ ุงูุถุฑูุจุฉุ ุงูุฅุฌูุงูู
- **ุฅุถุงูุงุช ุงุฎุชูุงุฑูุฉ**: ุทุฑููุฉ ุงูุณุฏุงุฏ ุงููุชููุนุฉุ ููุงุญุธุงุช ููุญุณุงุจุงุช

### 3. ุชุชุจุน ุงูุทูุจุงุช
- ุญุงูุงุช: (ุชู ุงูุฅุฑุณุงู - ุชุญุช ุงูุฅุฌุฑุงุก - ุชู ุงูุฅุตุฏุงุฑ)
- ููุน ุงูุชูุฑุงุฑ ูุน ุฎูุงุฑ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู

---

## ุงูููููุงุช ุงูุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

```text
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    invoice_requests                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                    UUID (PK)                              โ
โ quote_id              UUID (FK โ crm_quotes)                 โ
โ organization_id       UUID (FK โ client_organizations)       โ
โ request_number        TEXT (auto: INV-REQ-YYYY-NNNN)        โ
โ status                TEXT (sent/processing/issued)          โ
โ sent_at               TIMESTAMP                              โ
โ sent_by               UUID (FK โ staff_members)              โ
โ external_invoice_no   TEXT (nullable - ููููุฃ ูุงุญูุงู)         โ
โ issued_at             TIMESTAMP (nullable)                   โ
โ resend_reason         TEXT (nullable)                        โ
โ notes_for_accounts    TEXT (nullable)                        โ
โ expected_payment_method TEXT (nullable)                      โ
โ created_at            TIMESTAMP                              โ
โ updated_at            TIMESTAMP                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุฅุนุฏุงุฏุงุช ุงููุธุงู
- ุฅุถุงูุฉ `accounts_email` ูู system_settings ูุจุฑูุฏ ูุณุคูู ุงูุญุณุงุจุงุช

### ุงููููุงุช ุงูุฌุฏูุฏุฉ

| ุงูููู | ุงููุตู |
|-------|-------|
| `src/components/crm/modals/InvoiceRequestModal.tsx` | ูููุฐุฌ ุทูุจ ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ |
| `supabase/functions/send-invoice-request/index.ts` | ุฅุฑุณุงู ุงูุจุฑูุฏ ููุญุณุงุจุงุช |
| `src/components/crm/InvoiceRequestStatus.tsx` | ุนุฑุถ ุญุงูุฉ ุทูุจ ุงููุงุชูุฑุฉ |

### ุชุญุฏูุซ ุงููููุงุช ุงููุงุฆูุฉ

| ุงูููู | ุงูุชุนุฏูู |
|-------|---------|
| `src/pages/admin/crm/QuoteDetailsPage.tsx` | ุฅุถุงูุฉ ุฒุฑ ุงูุทูุจ ูุนุฑุถ ุงูุญุงูุฉ |
| `src/pages/admin/SettingsPage.tsx` | ุฅุถุงูุฉ ุญูู ุจุฑูุฏ ุงูุญุณุงุจุงุช |
| `src/components/crm/tabs/SalesTab.tsx` | ุนุฑุถ ุนุฑูุถ ุงูุฃุณุนุงุฑ ูุงูููุงุชูุฑ |
| `supabase/functions/_shared/email-templates.ts` | ูุงูุจ ุจุฑูุฏ ุทูุจ ุงููุงุชูุฑุฉ |

---

## ุชูุงุตูู ุงูุชูููุฐ

### 1. ุฌุฏูู invoice_requests
```sql
CREATE TABLE invoice_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_id UUID NOT NULL REFERENCES crm_quotes(id),
  organization_id UUID NOT NULL REFERENCES client_organizations(id),
  request_number TEXT NOT NULL UNIQUE,
  status TEXT NOT NULL DEFAULT 'sent' CHECK (status IN ('sent', 'processing', 'issued')),
  sent_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  sent_by UUID REFERENCES staff_members(id),
  external_invoice_no TEXT,
  issued_at TIMESTAMPTZ,
  resend_reason TEXT,
  notes_for_accounts TEXT,
  expected_payment_method TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ููุน ุชูุฑุงุฑ ุงูุทูุจ ูููุณ ุงูุนุฑุถ (ุฅูุง ุจุณุจุจ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู)
CREATE UNIQUE INDEX idx_invoice_requests_quote_active 
ON invoice_requests(quote_id) 
WHERE status != 'issued';
```

### 2. ูููุฐุฌ ุทูุจ ุงููุงุชูุฑุฉ (InvoiceRequestModal)
ูุนุฑุถ ููุชูุญ ุชุฃููุฏ:
- **ูุณู ุจูุงูุงุช ุงูุนููู**:
  - ุงุณู ุงูุฌูุฉ (ูู client_organizations.name)
  - ุฑูู ุงูุณุฌู ุงูุชุฌุงุฑู (registration_number)
  - ุงูุฑูู ุงูุถุฑูุจู (tax_number)
  - ุฌูุฉ ุงูุงุชุตุงู: ุงูุงุณู + ุงูุจุฑูุฏ + ุงูุฌูุงู

- **ูุณู ุงูุนููุงู ุงููุทูู**:
  - ุงููุฏููุฉ (city)
  - ุงูุญู (district)
  - ุงูุดุงุฑุน (street_name)
  - ุฑูู ุงููุจูู (building_number)
  - ุงูุฑูุฒ ุงูุจุฑูุฏู (postal_code)
  - ุงูุฑูู ุงูุฅุถุงูู (secondary_number)

- **ูุณู ุจูุงูุงุช ุงููุงุชูุฑุฉ**:
  - ุฑูู ุนุฑุถ ุงูุณุนุฑ
  - ุชุงุฑูุฎ ุงูุนุฑุถ
  - ูุตู (ุนููุงู ุงูุนุฑุถ + ุงูุฎุทุฉ)
  - ุงููุจูุบ ูุจู ุงูุถุฑูุจุฉ
  - ุงูุฎุตู (ุฅู ูุฌุฏ)
  - ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (15%)
  - ุงูุฅุฌูุงูู ุงูููุงุฆู

- **ูุณู ุฅุถุงูู**:
  - ุทุฑููุฉ ุงูุณุฏุงุฏ ุงููุชููุนุฉ (ุงุฎุชูุงุฑู)
  - ููุงุญุธุงุช ููุญุณุงุจุงุช (ุงุฎุชูุงุฑู)

### 3. Edge Function: send-invoice-request
```text
ุงููุฏุฎูุงุช:
- quote_id
- notes_for_accounts
- expected_payment_method
- sent_by (staff_id)

ุงูุนูููุงุช:
1. ุฌูุจ ุจูุงูุงุช ุงูุนุฑุถ ุงููุงููุฉ + ุงูุนููู + ุงูุนููุงู
2. ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุทูุจ ุณุงุจู ุบูุฑ ููุชูู
3. ุฅูุดุงุก ุณุฌู ูู invoice_requests
4. ุฅุนุฏุงุฏ ูุงูุจ ุงูุจุฑูุฏ ูุน ุฌููุน ุงูุจูุงูุงุช
5. ุฅุฑูุงู PDF ุนุฑุถ ุงูุณุนุฑ
6. ุฅุฑุณุงู ุงูุจุฑูุฏ ูุจุฑูุฏ ุงูุญุณุงุจุงุช
7. ุชุณุฌูู ูู client_timeline

ุงููุฎุฑุฌุงุช:
- success: boolean
- request_number: string
```

### 4. ูุงูุจ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
```text
ุงูููุถูุน: ุทูุจ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ โ [ุงุณู ุงูุนููู] โ ุนุฑุถ ุณุนุฑ [ุฑูู ุงูุนุฑุถ]

ุงููุญุชูู:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            ๐งพ ุทูุจ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ุจูุงูุงุช ุงูุนููู                            โ
โ   โข ุงูุงุณู: [ุงุณู ุงูุฌูุฉ]                      โ
โ   โข ุงูุณุฌู ุงูุชุฌุงุฑู: [ุฑูู]                    โ
โ   โข ุงูุฑูู ุงูุถุฑูุจู: [ุฑูู]                    โ
โ   โข ุฌูุฉ ุงูุงุชุตุงู: [ุงูุงุณู] - [ุงูุจุฑูุฏ]         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ุงูุนููุงู ุงููุทูู                           โ
โ   [ุงููุฏููุฉ] - [ุงูุญู] - [ุงูุดุงุฑุน]             โ
โ   ูุจูู [ุฑูู] - ุงูุฑูุฒ ุงูุจุฑูุฏู [ุฑูู]          โ
โ   ุงูุฑูู ุงูุฅุถุงูู: [ุฑูู]                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฐ ุชูุงุตูู ุงููุงุชูุฑุฉ                          โ
โ   โข ุฑูู ุงูุนุฑุถ: [ุฑูู]                        โ
โ   โข ุงููุจูุบ ูุจู ุงูุถุฑูุจุฉ: [ูุจูุบ] ุฑ.ุณ          โ
โ   โข ุงูุฎุตู: [ูุจูุบ/ูุณุจุฉ]                      โ
โ   โข ุถุฑูุจุฉ 15%: [ูุจูุบ] ุฑ.ุณ                   โ
โ   โข ุงูุฅุฌูุงูู: [ูุจูุบ] ุฑ.ุณ                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ุงููุฑููุงุช: PDF ุนุฑุถ ุงูุณุนุฑ                  โ
โ ๐ ุฑุงุจุท ุงูุนุฑุถ: [ุฑุงุจุท]                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 5. ุชุญุฏูุซ SalesTab
- ุนุฑุถ ูุงุฆูุฉ ุนุฑูุถ ุงูุฃุณุนุงุฑ ุงููุฑุชุจุทุฉ ุจุงูุนููู ูู ุฌุฏูู `crm_quotes`
- ุนุฑุถ ูุงุฆูุฉ ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจุงูุนููู ูู ุฌุฏูู `client_invoices`
- ุฅุถุงูุฉ ูุนูููุงุช ุญุงูุฉ ุงูุณุฏุงุฏ ูุขููุฉ ุงูุฏูุน

### 6. ุชุญุฏูุซ ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
- ุฅุถุงูุฉ ุญูู "ุจุฑูุฏ ูุณุคูู ุงูุญุณุงุจุงุช" (accounts_email)
- ููุณุชุฎุฏู ููุฌูุฉ ูุทูุจุงุช ุฅุตุฏุงุฑ ุงูููุงุชูุฑ

---

## ุชุฏูู ุงูุนูู

```text
[ุนุฑุถ ุณุนุฑ ูุนุชูุฏ/ูุฑุณู]
        โ
        โผ
[ุถุบุท ุฒุฑ "ุทูุจ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ"]
        โ
        โผ
[ูููุฐุฌ ุชุฃููุฏ ุงูุจูุงูุงุช]
        โ
        โผ
[ุฅุฑุณุงู ุงูุทูุจ]
        โ
        โโโโถ [ุฅูุดุงุก ุณุฌู invoice_requests ุจุญุงูุฉ "sent"]
        โ
        โโโโถ [ุฅุฑุณุงู ุจุฑูุฏ ููุณุคูู ุงูุญุณุงุจุงุช]
        โ
        โโโโถ [ุชุณุฌูู ูู timeline ุงูุนููู]
        โ
        โผ
[ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ + ุชุญุฏูุซ ุงูุญุงูุฉ ูู ุงูุตูุญุฉ]
```

---

## ุฎุทูุงุช ุงูุชูููุฐ

1. **ุฅูุดุงุก ุฌุฏูู invoice_requests** ูุน ุงูุชุญูู ูู ุงูุจูุงูุงุช ูุงูููุงุฑุณ

2. **ุฅุถุงูุฉ ุฅุนุฏุงุฏ accounts_email** ูู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช

3. **ุฅูุดุงุก ูุงูุจ ุงูุจุฑูุฏ** invoiceRequestTemplate ูู email-templates.ts

4. **ุฅูุดุงุก Edge Function** send-invoice-request

5. **ุฅูุดุงุก ูููู InvoiceRequestModal** ูุน ุฌููุน ุงูุฃูุณุงู

6. **ุชุญุฏูุซ QuoteDetailsPage**:
   - ุฅุถุงูุฉ ุฒุฑ "ุทูุจ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ"
   - ุนุฑุถ ุญุงูุฉ ุงูุทูุจ ุฅู ูุฌุฏ
   - ููุน ุงูุชูุฑุงุฑ ูุน ุฎูุงุฑ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู

7. **ุชุญุฏูุซ SalesTab** ูุนุฑุถ ุนุฑูุถ ุงูุฃุณุนุงุฑ ูุงูููุงุชูุฑ ููุนููู

---

## ุงูุฃูุงู ูุงูุตูุงุญูุงุช

- RLS ุนูู ุฌุฏูู invoice_requests ููููุธููู ุงููุตุฑุญ ููู
- ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุฑุถ ูุจู ุงูุณูุงุญ ุจุงูุทูุจ
- ุชุณุฌูู ุฌููุน ุงูุนูููุงุช ูู ุณุฌู ุงููุดุงุท

---

## ููุงุญุธุงุช ุฅุถุงููุฉ

- PDF ุนุฑุถ ุงูุณุนุฑ ููุฑูู ุชููุงุฆูุงู ูุน ุงูุจุฑูุฏ
- ูููู ูุงุญูุงู ุฅุถุงูุฉ ุชุตุฏูุฑ JSON/CSV ูุจูุงูุงุช ุงููุงุชูุฑุฉ
- ุญุงูุฉ "ุชู ุงูุฅุตุฏุงุฑ" ุชูุญุฏูุซ ูุฏููุงู ูู ูุจู ุงูุฅุฏุงุฑุฉ ูุน ุฑูู ุงููุงุชูุฑุฉ ุงูุฎุงุฑุฌู
