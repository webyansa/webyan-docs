
# تطوير نظام Workflow احترافي للفرص (Deals)

## تحليل الوضع الحالي

### الموجود:
- صفحة `DealsPage.tsx` مع لوحة Kanban بسيطة
- جدول `crm_opportunities` يحتوي على البيانات الأساسية
- جدول `crm_quotes` لعروض الأسعار
- جدول `crm_stage_transitions` لتتبع الانتقالات
- نموذج واحد فقط لتغيير المرحلة (بدون إجراءات مخصصة)

### المفقود:
- جدول خاص لأنشطة الفرص (Opportunity Activities)
- مراحل إضافية مثل "اجتماع مجدول"
- نماذج مخصصة لكل مرحلة (اجتماع، عرض سعر، رفض)
- إمكانية إضافة ملاحظات بدون تغيير المرحلة
- سجل زمني داخل الفرصة

---

## المرحلة 1: تحديث قاعدة البيانات

### 1.1 إنشاء جدول `crm_opportunity_activities`

```sql
CREATE TABLE crm_opportunity_activities (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  opportunity_id uuid NOT NULL REFERENCES crm_opportunities(id) ON DELETE CASCADE,
  
  -- نوع النشاط
  activity_type text NOT NULL,
  -- 'note', 'meeting_scheduled', 'meeting_report', 'quote_sent', 'stage_change', 'rejection', 'call', 'email'
  
  -- تفاصيل النشاط
  title text NOT NULL,
  description text,
  
  -- بيانات إضافية حسب نوع النشاط (JSON)
  metadata jsonb DEFAULT '{}',
  
  -- من قام بالنشاط
  performed_by uuid REFERENCES staff_members(id),
  performed_by_name text,
  
  -- الوقت
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_opportunity_activities ON crm_opportunity_activities(opportunity_id);
CREATE INDEX idx_opportunity_activities_type ON crm_opportunity_activities(activity_type);
```

### 1.2 إضافة حقل `document_url` لجدول `crm_quotes`

```sql
ALTER TABLE crm_quotes 
ADD COLUMN IF NOT EXISTS document_url text;
```

### 1.3 تحديث مراحل الفرص في `pipelineConfig.ts`

```typescript
// المراحل الجديدة (7 مراحل)
export type DealStage = 
  | 'new_opportunity'     // فرصة جديدة
  | 'meeting_scheduled'   // اجتماع مجدول  ← جديد
  | 'meeting_done'        // اجتماع تم
  | 'proposal_sent'       // عرض سعر مرسل
  | 'pending_approval'    // بانتظار الاعتماد
  | 'approved'            // معتمد
  | 'rejected';           // مرفوض
```

---

## المرحلة 2: تعريف الإجراءات الإلزامية لكل مرحلة

### جدول الإجراءات:

| من المرحلة | إلى المرحلة | الإجراء الإلزامي | النموذج المطلوب |
|-----------|-------------|-----------------|----------------|
| أي مرحلة | اجتماع مجدول | جدولة اجتماع | `ScheduleMeetingModal` |
| اجتماع مجدول | اجتماع تم | كتابة تقرير الاجتماع | `MeetingReportModal` |
| أي مرحلة | عرض مرسل | إنشاء عرض سعر | `CreateQuoteModal` |
| عرض مرسل | بانتظار الاعتماد | ملاحظة إلزامية | `StageNoteModal` |
| بانتظار الاعتماد | معتمد | تأكيد الاعتماد | `ApprovalModal` |
| أي مرحلة | مرفوض | سبب الرفض | `RejectionModal` |

---

## المرحلة 3: المكونات الجديدة

### 3.1 `ScheduleMeetingModal.tsx` - جدولة اجتماع

```text
┌─────────────────────────────────────────────────────────────────┐
│  📅 جدولة اجتماع                                        [✕]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  الفرصة: شركة ABC للتقنية                                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ تاريخ الاجتماع *                                            ││
│  │ [___/___/____] [__:__]                                      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ مدة الاجتماع                                                ││
│  │ [30 دقيقة ▼]                                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ نوع الاجتماع                                                ││
│  │ [○ حضوري  ○ عن بُعد  ○ مكالمة هاتفية]                       ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ ملاحظات                                                     ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│                          [إلغاء]  [جدولة الاجتماع]              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**الحقول:**
- تاريخ ووقت الاجتماع (إلزامي)
- مدة الاجتماع (30/60/90 دقيقة)
- نوع الاجتماع (حضوري/عن بُعد/مكالمة)
- ملاحظات (اختياري)

### 3.2 `MeetingReportModal.tsx` - تقرير الاجتماع

```text
┌─────────────────────────────────────────────────────────────────┐
│  📝 تقرير الاجتماع                                      [✕]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  الفرصة: شركة ABC للتقنية                                       │
│  تاريخ الاجتماع: 15 يناير 2024 - 10:00 ص                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ الحاضرون *                                                  ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ ملخص الاجتماع *                                             ││
│  │ [___________________________________________]               ││
│  │ [___________________________________________]               ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ نتيجة الاجتماع *                                            ││
│  │ [○ إيجابي - العميل مهتم  ○ محايد - يحتاج متابعة  ○ سلبي]    ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ الخطوة التالية *                                            ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│                          [إلغاء]  [حفظ التقرير]                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**الحقول:**
- الحاضرون (إلزامي)
- ملخص الاجتماع (إلزامي)
- نتيجة الاجتماع (إيجابي/محايد/سلبي)
- الخطوة التالية (إلزامي)

### 3.3 `CreateQuoteModal.tsx` - إنشاء عرض سعر

```text
┌─────────────────────────────────────────────────────────────────┐
│  📄 إنشاء عرض سعر                                       [✕]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  الفرصة: شركة ABC للتقنية                                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ عنوان العرض *                                               ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ نوع الخدمة *                                                ││
│  │ [○ اشتراك ويبيان  ○ منصة مخصصة]                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ الباقة (إذا اشتراك)                                         ││
│  │ [أساسي ▼]  [شهري ▼]                                         ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ قيمة العرض *                                                ││
│  │ [___________] ر.س                                           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ صلاحية العرض                                                ││
│  │ [30 يوم ▼]                                                  ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ ملف العرض (PDF)                                             ││
│  │ [📎 رفع ملف] أو [🔗 إضافة رابط]                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ ملاحظات على العرض                                           ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│                          [إلغاء]  [إنشاء وإرسال العرض]          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**الحقول:**
- عنوان العرض (إلزامي)
- نوع الخدمة (إلزامي)
- الباقة (إذا اشتراك)
- قيمة العرض (إلزامي)
- صلاحية العرض (15/30/60 يوم)
- ملف العرض أو رابط (اختياري)
- ملاحظات (اختياري)

### 3.4 `RejectionModal.tsx` - سبب الرفض

```text
┌─────────────────────────────────────────────────────────────────┐
│  ❌ تسجيل رفض الفرصة                                    [✕]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  الفرصة: شركة ABC للتقنية                                       │
│  القيمة: 25,000 ر.س                                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ سبب الرفض *                                                 ││
│  │ [○ السعر مرتفع                                              ││
│  │  ○ لا يوجد رد من العميل                                     ││
│  │  ○ تأجيل المشروع                                            ││
│  │  ○ اختار مزود آخر                                           ││
│  │  ○ عدم توافق المتطلبات                                      ││
│  │  ○ سبب آخر]                                                 ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ تفاصيل إضافية *                                             ││
│  │ [___________________________________________]               ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ هل يمكن إعادة التواصل مستقبلاً؟                             ││
│  │ [○ نعم  ○ لا  ○ غير محدد]                                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│                          [إلغاء]  [تأكيد الرفض]                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**الحقول:**
- سبب الرفض (إلزامي - من قائمة)
- تفاصيل إضافية (إلزامي)
- إمكانية التواصل مستقبلاً (اختياري)

### 3.5 `AddNoteModal.tsx` - إضافة ملاحظة

```text
┌─────────────────────────────────────────────────────────────────┐
│  📝 إضافة ملاحظة                                        [✕]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  الفرصة: شركة ABC للتقنية                                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ الملاحظة *                                                  ││
│  │ [___________________________________________]               ││
│  │ [___________________________________________]               ││
│  │ [___________________________________________]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│                          [إلغاء]  [حفظ الملاحظة]                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.6 `OpportunityTimeline.tsx` - السجل الزمني

```text
┌───────────────────────────────────────────────────────────────────────────────────────┐
│  📜 سجل النشاط                                                                        │
├───────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│  ┌─ اليوم ──────────────────────────────────────────────────────────────────────────┐ │
│  │  🔵 10:30 ص │ 📄 عرض سعر مرسل                                    أحمد محمد      │ │
│  │             │ تم إرسال عرض سعر بقيمة 25,000 ر.س                                  │ │
│  │             │ [📎 عرض_سعر.pdf]                                                    │ │
│  │  ──────────────────────────────────────────────────────────────────────────────  │ │
│  │  🟢 09:15 ص │ 📝 ملاحظة                                          سارة أحمد      │ │
│  │             │ العميل طلب خصم 10% - بانتظار موافقة المدير                         │ │
│  └──────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
│  ┌─ أمس ────────────────────────────────────────────────────────────────────────────┐ │
│  │  🟡 03:00 م │ 📅 اجتماع تم                                        أحمد محمد      │ │
│  │             │ اجتماع عن بُعد - 45 دقيقة                                          │ │
│  │             │ الحاضرون: محمد علي (العميل)، أحمد محمد (ويبيان)                     │ │
│  │             │ النتيجة: إيجابي - العميل مهتم بالاشتراك السنوي                      │ │
│  │  ──────────────────────────────────────────────────────────────────────────────  │ │
│  │  🔵 10:00 ص │ 📅 اجتماع مجدول                                     أحمد محمد      │ │
│  │             │ تم جدولة اجتماع يوم 15 يناير الساعة 3:00 م                         │ │
│  └──────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
│  ┌─ 12 يناير ───────────────────────────────────────────────────────────────────────┐ │
│  │  🟢 11:00 ص │ ⭐ تغيير المرحلة                                    النظام         │ │
│  │             │ من: فرصة جديدة → إلى: اجتماع مجدول                                 │ │
│  │             │ السبب: تم التواصل مع العميل ووافق على الاجتماع                     │ │
│  │  ──────────────────────────────────────────────────────────────────────────────  │ │
│  │  🔵 09:00 ص │ ➕ إنشاء الفرصة                                      أحمد محمد      │ │
│  │             │ تم إنشاء الفرصة من العميل المحتمل: شركة ABC                         │ │
│  └──────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────┘
```

---

## المرحلة 4: تحديث صفحة الفرص (DealsPage.tsx)

### 4.1 إضافة مرحلة "اجتماع مجدول"

### 4.2 تحديث منطق السحب والإفلات (Drag & Drop)

```typescript
// عند السحب من مرحلة إلى أخرى
const handleDragEnd = (dealId: string, fromStage: DealStage, toStage: DealStage) => {
  // منع السحب إلى نفس المرحلة
  if (fromStage === toStage) return;
  
  // تحديد النموذج المطلوب بناءً على المرحلة المستهدفة
  switch (toStage) {
    case 'meeting_scheduled':
      openModal('schedule_meeting', dealId);
      break;
    case 'meeting_done':
      openModal('meeting_report', dealId);
      break;
    case 'proposal_sent':
      openModal('create_quote', dealId);
      break;
    case 'pending_approval':
    case 'approved':
      openModal('stage_note', dealId, toStage);
      break;
    case 'rejected':
      openModal('rejection', dealId);
      break;
  }
};
```

### 4.3 إضافة زر "إضافة ملاحظة" في بطاقة الفرصة

### 4.4 إضافة رابط "عرض السجل الزمني"

---

## المرحلة 5: صفحة تفاصيل الفرصة (جديدة)

إنشاء صفحة `DealDetailsPage.tsx` تعرض:
- معلومات الفرصة الأساسية
- المرحلة الحالية مع إمكانية التغيير
- السجل الزمني الكامل
- عروض الأسعار المرتبطة
- إجراءات سريعة (إضافة ملاحظة، جدولة اجتماع، إلخ)

---

## المرحلة 6: أسباب الرفض المحددة

```typescript
export const rejectionReasons = [
  { value: 'price_high', label: 'السعر مرتفع' },
  { value: 'no_response', label: 'لا يوجد رد من العميل' },
  { value: 'postponed', label: 'تأجيل المشروع' },
  { value: 'competitor', label: 'اختار مزود آخر' },
  { value: 'requirements_mismatch', label: 'عدم توافق المتطلبات' },
  { value: 'budget_issues', label: 'مشاكل في الميزانية' },
  { value: 'other', label: 'سبب آخر' },
];
```

---

## الملفات المطلوب إنشاؤها / تعديلها

### ملفات جديدة:
| الملف | الوصف |
|-------|-------|
| `src/components/crm/modals/ScheduleMeetingModal.tsx` | نموذج جدولة اجتماع |
| `src/components/crm/modals/MeetingReportModal.tsx` | نموذج تقرير الاجتماع |
| `src/components/crm/modals/CreateQuoteModal.tsx` | نموذج إنشاء عرض سعر |
| `src/components/crm/modals/RejectionModal.tsx` | نموذج سبب الرفض |
| `src/components/crm/modals/AddNoteModal.tsx` | نموذج إضافة ملاحظة |
| `src/components/crm/OpportunityTimeline.tsx` | السجل الزمني للفرصة |
| `src/pages/admin/crm/DealDetailsPage.tsx` | صفحة تفاصيل الفرصة |

### ملفات للتعديل:
| الملف | التعديل |
|-------|---------|
| `src/lib/crm/pipelineConfig.ts` | إضافة مرحلة `meeting_scheduled` + أسباب الرفض |
| `src/pages/admin/crm/DealsPage.tsx` | تحديث Kanban + منطق السحب والإفلات |
| `src/App.tsx` | إضافة مسار صفحة تفاصيل الفرصة |

### Migration SQL:
- إنشاء جدول `crm_opportunity_activities`
- إضافة `document_url` لجدول `crm_quotes`

---

## ترتيب التنفيذ

### الخطوة 1: تحديث قاعدة البيانات
1. إنشاء جدول `crm_opportunity_activities`
2. تحديث جدول `crm_quotes`

### الخطوة 2: تحديث التكوينات
1. تحديث `pipelineConfig.ts` بالمراحل الجديدة وأسباب الرفض

### الخطوة 3: إنشاء المكونات الأساسية
1. `AddNoteModal.tsx`
2. `OpportunityTimeline.tsx`

### الخطوة 4: إنشاء نماذج المراحل
1. `ScheduleMeetingModal.tsx`
2. `MeetingReportModal.tsx`
3. `CreateQuoteModal.tsx`
4. `RejectionModal.tsx`

### الخطوة 5: تحديث صفحة الفرص
1. إضافة مرحلة "اجتماع مجدول"
2. تحديث منطق السحب والإفلات
3. ربط النماذج بالانتقالات

### الخطوة 6: صفحة تفاصيل الفرصة
1. إنشاء `DealDetailsPage.tsx`
2. تسجيل المسار في Router

---

## النتيجة المتوقعة

```text
تدفق العمل الجديد:
───────────────────────────────────────────────────────────────────

فرصة جديدة ─────────────────────────────────────────────────────┐
     │                                                          │
     │ [جدولة اجتماع] → نموذج تاريخ/وقت/نوع                     │
     ▼                                                          │
اجتماع مجدول ──────────────────────────────────────────────────┐│
     │                                                         ││
     │ [كتابة تقرير] → نموذج الحاضرين/الملخص/النتيجة          ││
     ▼                                                         ││
اجتماع تم ─────────────────────────────────────────────────────┐││
     │                                                        │││
     │ [إنشاء عرض] → نموذج القيمة/الباقة/الملف               │││
     ▼                                                        │││
عرض سعر مرسل ──────────────────────────────────────────────────┐│││
     │                                                       ││││
     │ [ملاحظة] → نموذج ملاحظة إلزامية                       ││││
     ▼                                                       ││││
بانتظار الاعتماد ──────────────────────────────────────────┐  ││││
     │                    │                                │  ││││
     │ [اعتماد]          │ [رفض]                           │  ││││
     ▼                    ▼                                │  ││││
  معتمد ✓              مرفوض ✗                            │  ││││
     │                    │                                │  ││││
     │                    └─ نموذج سبب الرفض               │  ││││
     │                                                     │  ││││
     └─ إنشاء ملف عميل تلقائي                              │  ││││
                                                          │  ││││
───────────────────────────────────────────────────────────────────

في أي مرحلة يمكن:
• إضافة ملاحظة (بدون تغيير المرحلة)
• عرض السجل الزمني الكامل
• الانتقال إلى "مرفوض" مع تحديد السبب
```

---

## الفوائد من هذا النظام

1. **توثيق كامل** لكل خطوة في مسار الفرصة
2. **منع النقل الصامت** - كل انتقال يتطلب إجراء موثق
3. **تتبع المسؤولية** - معرفة من قام بكل إجراء ومتى
4. **تحليل أسباب الرفض** - بيانات قيّمة لتحسين المبيعات
5. **واجهة احترافية** مشابهة لـ HubSpot/Zoho CRM
6. **قابلية للتوسع** - سهولة إضافة إجراءات ومراحل جديدة
