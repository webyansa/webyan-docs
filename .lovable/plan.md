
# خطة تحديث تبويب الاشتراك

## ملخص التغييرات المطلوبة
تحويل تبويب الاشتراك من عرض للقراءة فقط إلى شاشة إدارة كاملة لبيانات اشتراك العميل، مع ربط إغلاق المشروع ببدء الاشتراك تلقائياً.

---

## المتطلبات الرئيسية

### 1. ربط إغلاق المشروع ببدء الاشتراك
- عند إغلاق مشروع في crm_implementations (status = 'completed')
- يتم تحديث subscription_start_date في client_organizations تلقائياً
- تفعيل حالة الاشتراك إلى 'active'

### 2. إدارة بيانات الاشتراك
| الحقل | الوصف |
|-------|-------|
| تاريخ الاشتراك | subscription_start_date |
| نوع الباقة | subscription_plan (من pricing_plans) |
| قيمة الباقة | subscription_value (جديد) |
| تاريخ الانتهاء | subscription_end_date |
| تاريخ انتهاء الدومين | domain_expiration_date (جديد) |

### 3. نظام الملاحظات
- جدول جديد لملاحظات الاشتراك
- تسجيل الموظف الذي أضاف الملاحظة
- عرض قائمة الملاحظات مع التاريخ واسم الموظف

---

## التفاصيل التقنية

### أولاً: تعديلات قاعدة البيانات

**1. إضافة أعمدة جديدة لجدول client_organizations:**
```text
- subscription_value (numeric) - قيمة الاشتراك
- domain_expiration_date (date) - تاريخ انتهاء الدومين
```

**2. إنشاء جدول ملاحظات الاشتراك:**
```text
subscription_notes
├── id (uuid, primary key)
├── organization_id (uuid, FK → client_organizations)
├── note (text)
├── created_by (uuid, FK → staff_members)
├── created_at (timestamp)
```

**3. إنشاء Database Trigger:**
- عند تحديث crm_implementations.status إلى 'completed'
- تحديث client_organizations مع:
  - subscription_start_date = الآن
  - subscription_status = 'active'

### ثانياً: تحديث مكون SubscriptionTab

**1. واجهة التعديل:**
- نافذة منبثقة لتعديل بيانات الاشتراك
- قائمة منسدلة لاختيار الباقة من pricing_plans
- حقول التواريخ مع منتقي التاريخ

**2. عرض البيانات المحسّن:**
```text
┌─────────────────────────────────────────────┐
│ [حالة الاشتراك] [الباقة] [الأيام المتبقية]  │
├─────────────────────────────────────────────┤
│ تفاصيل الاشتراك              [تعديل] [تجديد]│
│ ─────────────────────────────────────────── │
│ تاريخ البدء: XX/XX/XXXX                     │
│ تاريخ الانتهاء: XX/XX/XXXX                  │
│ قيمة الاشتراك: XXXX ريال                    │
│ انتهاء الدومين: XX/XX/XXXX                  │
├─────────────────────────────────────────────┤
│ الملاحظات                    [إضافة ملاحظة] │
│ ─────────────────────────────────────────── │
│ • ملاحظة 1 - أحمد - 01/01/2025             │
│ • ملاحظة 2 - محمد - 15/01/2025             │
└─────────────────────────────────────────────┘
```

**3. نظام الملاحظات:**
- إضافة ملاحظة جديدة مع تسجيل الموظف الحالي
- عرض الملاحظات مرتبة من الأحدث
- إمكانية حذف الملاحظات

### ثالثاً: الملفات المتأثرة

| الملف | التغيير |
|-------|---------|
| `src/components/crm/tabs/SubscriptionTab.tsx` | إعادة كتابة كاملة |
| `src/pages/admin/crm/CustomerProfilePage.tsx` | تمرير بيانات إضافية |
| قاعدة البيانات | إضافة أعمدة وجدول وtrigger |

---

## خطوات التنفيذ

1. **إنشاء Migration لقاعدة البيانات**
   - إضافة الأعمدة الجديدة
   - إنشاء جدول الملاحظات مع RLS
   - إنشاء Trigger لربط إغلاق المشروع

2. **تحديث SubscriptionTab**
   - إضافة نافذة تعديل البيانات
   - جلب الباقات من pricing_plans
   - إضافة قسم الملاحظات
   - إضافة وظائف الحفظ والتحديث

3. **تحديث CustomerProfilePage**
   - تمرير callback لإعادة تحميل البيانات

---

## ملاحظات إضافية

- سيتم استخدام المكونات الموجودة (Dialog, Input, Select, etc.)
- الملاحظات ستظهر مع اسم الموظف وتاريخ الإضافة
- تنبيه عند اقتراب انتهاء الدومين (قبل 30 يوم)
