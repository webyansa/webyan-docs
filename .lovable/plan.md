
# خطة: إعادة تصميم مراحل عرض السعر المالية (5 مراحل متتابعة)

## الوصف

استبدال قسم "حالة الدفع والفاتورة" الحالي (الذي يعرض حالتين مسطحتين) بنظام مراحل متتابعة (Stepper) احترافي يمنع الانتقال للمرحلة التالية إلا بعد إكمال السابقة.

---

## المراحل الخمس

| # | المرحلة | الحقول المطلوبة | شرط التفعيل |
|---|---------|----------------|-------------|
| 1 | تعميد العميل | نعم/لا + سبب الرفض (إذا لا) | عرض السعر بحالة "معتمد" |
| 2 | تأكيد الدفع | نعم/لا + المبلغ المحول + رقم التحويل | اكتمال المرحلة 1 بنجاح |
| 3 | طلب إصدار فاتورة | تم الطلب / لم يتم | اكتمال المرحلة 2 بنجاح |
| 4 | إصدار الفاتورة | تم الإصدار / لا (يُحدّث تلقائياً عند تأكيد المحاسب) | اكتمال المرحلة 3 |
| 5 | إرسال الفاتورة للعميل | تم الإرسال / لم يتم + إرسال بريد شكر تلقائي | اكتمال المرحلة 4 |

---

## التغييرات المطلوبة

### 1. تعديل قاعدة البيانات

اضافة أعمدة جديدة لجدول `crm_quotes`:

- `client_approved` (boolean, default null) -- تعميد العميل
- `client_approved_at` (timestamptz)
- `client_rejection_reason` (text) -- سبب عدم التعميد
- `payment_confirmed` (boolean, default false) -- تأكيد الدفع
- `payment_amount` (numeric) -- المبلغ المحول
- `payment_transfer_number` (text) -- رقم التحويل
- `payment_confirmed_at` (timestamptz)
- `invoice_sent_to_client` (boolean, default false) -- هل تم ارسال الفاتورة للعميل
- `invoice_sent_to_client_at` (timestamptz)

(الحقول الموجودة مسبقاً: `payment_status`, `invoice_status` ستبقى للتوافق لكن المراحل الجديدة ستتحكم بالمنطق)

### 2. إنشاء مكوّن Stepper جديد

**ملف جديد:** `src/components/crm/quotes/QuoteFinancialStepper.tsx`

مكوّن يعرض 5 مراحل على شكل Stepper عمودي احترافي:
- كل مرحلة تظهر بأيقونة دائرية ملونة (رمادي = منتظرة، أزرق = جارية، أخضر = مكتملة، أحمر = مرفوضة)
- خطوط عمودية تربط المراحل
- كل مرحلة تعرض الحالة والبيانات المسجلة
- زر إجراء يظهر فقط في المرحلة النشطة
- المراحل المغلقة (التي لم يحن دورها) تظهر باللون الرمادي مع قفل

### 3. نوافذ الإجراءات (Dialogs)

**المرحلة 1 - تعميد العميل:**
- Dialog يحتوي: اختيار (نعم/لا) + حقل سبب الرفض (يظهر عند اختيار "لا")
- عند التأكيد يُحدّث `client_approved` و `client_approved_at`

**المرحلة 2 - تأكيد الدفع:**
- Dialog يحتوي: المبلغ المحول (رقمي) + رقم التحويل (نص)
- عند التأكيد يُحدّث `payment_confirmed`, `payment_amount`, `payment_transfer_number`, `payment_status = 'paid'`

**المرحلة 3 - طلب إصدار فاتورة:**
- يفتح `InvoiceRequestModal` الموجود حالياً (لا تغيير)
- عند النجاح يُحدّث `invoice_status = 'requested'`

**المرحلة 4 - إصدار الفاتورة:**
- تُحدّث تلقائياً عبر المحاسب من صفحة `InvoiceConfirmPage`
- أو يدوياً من زر "تأكيد الإصدار" في الـ Stepper

**المرحلة 5 - إرسال الفاتورة للعميل:**
- Dialog تأكيد: "هل تريد إرسال الفاتورة للعميل؟"
- عند التأكيد: يُرسل بريد شكر للعميل عبر Edge Function + يُحدّث `invoice_sent_to_client`

### 4. Edge Function لإرسال بريد شكر

**ملف جديد:** `supabase/functions/send-invoice-to-client/index.ts`

يرسل بريداً للعميل يحتوي:
- شكر على التعاون
- تفاصيل الفاتورة (رقمها، المبلغ)
- مرفق الفاتورة PDF (إن وُجد)

### 5. تحديث صفحة عرض السعر

**الملف:** `src/pages/admin/crm/QuoteDetailsPage.tsx`

- استبدال كارد "حالة الدفع والفاتورة" (السطور 1111-1190) بمكوّن `QuoteFinancialStepper` الجديد
- يظهر فقط عندما يكون العرض بحالة "معتمد" (accepted)

---

## التصميم المرئي للـ Stepper

```text
  [1] تعميد العميل ............... تم التعميد
   |
  [2] تأكيد الدفع ............... تم الدفع (5,000 ر.س - تحويل #12345)
   |
  [3] طلب إصدار فاتورة .......... تم الطلب (INV-REQ-001)
   |
  [4] إصدار الفاتورة ............ في الانتظار
   |
  [5] إرسال الفاتورة للعميل ..... مقفل
```

كل مرحلة مكتملة تظهر بدائرة خضراء مع علامة صح، المرحلة النشطة بدائرة زرقاء نابضة، والمراحل المقفلة بدائرة رمادية مع قفل.

---

## الملفات المتأثرة

| الملف | النوع | التعديل |
|---|---|---|
| Migration SQL | جديد | إضافة الأعمدة الجديدة |
| `src/components/crm/quotes/QuoteFinancialStepper.tsx` | جديد | مكوّن المراحل الخمس |
| `src/pages/admin/crm/QuoteDetailsPage.tsx` | تعديل | استبدال كارد الدفع بالـ Stepper |
| `supabase/functions/send-invoice-to-client/index.ts` | جديد | بريد شكر + إرسال فاتورة للعميل |
