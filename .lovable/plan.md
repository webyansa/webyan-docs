
# نظام إدارة عروض الأسعار الاحترافي (Quotations System)

---

## تحليل الوضع الحالي

### الموجود:
- جدول `crm_quotes` مع حقول: items (JSON), subtotal, discount_type, discount_value, tax_rate, tax_amount, total_amount, validity_days, status
- نموذج `CreateQuoteModal.tsx` بسيط (قيمة واحدة فقط بدون بنود تفصيلية)
- نظام قوالب بريد إلكتروني جاهز (`email-templates.ts`)
- دوال إرسال البريد (`smtp-sender.ts`)

### المفقود:
- جداول الخطط والأسعار (Plans)
- جدول الخدمات الإضافية (Add-on Services)
- جدول الحلول المخصصة (Custom Solutions)
- نموذج إنشاء عرض سعر متقدم (بنود متعددة)
- صفحة إدارة عروض الأسعار
- قالب PDF احترافي
- Edge Function لإرسال العرض بالبريد

---

## المرحلة 1: إنشاء جداول قاعدة البيانات

### 1.1 جدول الخطط والأسعار `pricing_plans`

| الحقل | النوع | الوصف |
|-------|------|-------|
| id | uuid | المعرف |
| name | text | اسم الخطة (أساسي، احترافي، مؤسسي) |
| name_en | text | الاسم بالإنجليزية |
| description | text | وصف الخطة |
| plan_type | text | نوع الخطة (subscription) |
| monthly_price | numeric | السعر الشهري |
| yearly_price | numeric | السعر السنوي |
| yearly_discount | integer | نسبة خصم السنوي (%) |
| features | jsonb | مميزات الخطة |
| is_active | boolean | حالة النشاط |
| sort_order | integer | الترتيب |

### 1.2 جدول الخدمات الإضافية `pricing_services`

| الحقل | النوع | الوصف |
|-------|------|-------|
| id | uuid | المعرف |
| name | text | اسم الخدمة |
| description | text | وصف الخدمة |
| service_type | text | نوع الخدمة (one_time / recurring) |
| price | numeric | السعر |
| unit | text | الوحدة (مرة، شهري، سنوي) |
| category | text | التصنيف |
| is_active | boolean | حالة النشاط |

### 1.3 جدول الحلول المخصصة `pricing_custom_solutions`

| الحقل | النوع | الوصف |
|-------|------|-------|
| id | uuid | المعرف |
| name | text | اسم الحل |
| description | text | الوصف |
| base_price | numeric | السعر التقديري الأساسي |
| price_note | text | ملاحظة على السعر |
| is_active | boolean | حالة النشاط |

### 1.4 تحديث جدول `crm_quotes`

إضافة حقول:
- `quote_type` (subscription / custom_platform / services_only)
- `billing_cycle` (monthly / yearly)
- `plan_id` (reference to pricing_plans)

---

## المرحلة 2: صفحة إدارة التسعير (Settings)

### 2.1 إنشاء صفحة `PricingSettingsPage.tsx`

واجهة لإدارة الخطط والخدمات تحتوي على:
- تبويب الخطط: إضافة/تعديل/حذف الخطط
- تبويب الخدمات: إضافة/تعديل/حذف الخدمات الإضافية
- تبويب الحلول المخصصة: إضافة/تعديل/حذف الحلول

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⚙️ إعدادات التسعير                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  [الخطط]  [الخدمات الإضافية]  [الحلول المخصصة]                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────┐ [+ إضافة خطة]│
│  │ الخطة الأساسية        │ شهري: 500 ر.س │ سنوي: 5,000 ر.س │ [تعديل][حذف] │
│  │ الخطة الاحترافية      │ شهري: 1,000 ر.س│ سنوي: 10,000ر.س│ [تعديل][حذف] │
│  │ الخطة المؤسسية        │ شهري: 2,500 ر.س│ سنوي: 25,000ر.س│ [تعديل][حذف] │
│  └──────────────────────────────────────────────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## المرحلة 3: نظام إنشاء عروض الأسعار المتقدم

### 3.1 نموذج `AdvancedQuoteModal.tsx`

نموذج متعدد الخطوات:

#### الخطوة 1: اختيار نوع البيع

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📄 إنشاء عرض سعر - الخطوة 1 من 3                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  اختر نوع البيع الأساسي:                                                   │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │ 📦 اشتراك منصة │  │ 🔧 منصة مخصصة  │  │ 🛠️ خدمات فقط   │              │
│  │                 │  │                 │  │                 │              │
│  │ اشتراك شهري أو │  │ تطوير منصة     │  │ خدمات إضافية   │              │
│  │ سنوي في ويبيان │  │ حسب الطلب      │  │ بدون اشتراك    │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                             │
│                                              [إلغاء]  [التالي →]            │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### الخطوة 2: تفاصيل العرض

**إذا اشتراك منصة:**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📄 إنشاء عرض سعر - الخطوة 2 من 3                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  اختر الخطة:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ [●] الخطة الأساسية      - 500 ر.س/شهر  |  5,000 ر.س/سنة               ││
│  │ [ ] الخطة الاحترافية    - 1,000 ر.س/شهر | 10,000 ر.س/سنة              ││
│  │ [ ] الخطة المؤسسية      - 2,500 ر.س/شهر | 25,000 ر.س/سنة              ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  مدة الاشتراك:                                                             │
│  [● شهري] [ سنوي (خصم 17%)]                                                │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  إضافة خدمات إضافية (اختياري):                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ [✓] تدريب الفريق                          500 ر.س (مرة واحدة)          ││
│  │ [ ] دعم فني متقدم                         200 ر.س/شهر                  ││
│  │ [✓] تخصيص الهوية البصرية                  1,000 ر.س (مرة واحدة)        ││
│  │ [ ] ترحيل البيانات                        1,500 ر.س (مرة واحدة)        ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│                                        [← السابق]  [إلغاء]  [التالي →]     │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### الخطوة 3: الملخص والإرسال

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📄 إنشاء عرض سعر - الخطوة 3 من 3                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  العميل: شركة ABC للتقنية                                                   │
│  الفرصة: تفعيل اشتراك ويبيان                                               │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ تفاصيل العرض                                                          │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │ البند                                    │ المدة    │ السعر           │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │ الخطة الاحترافية                         │ سنوي    │ 10,000 ر.س      │  │
│  │ تدريب الفريق                             │ مرة واحدة│ 500 ر.س        │  │
│  │ تخصيص الهوية البصرية                     │ مرة واحدة│ 1,000 ر.س      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                            المجموع الفرعي │          │ 11,500 ر.س     │  │
│  │                            ضريبة (15%)    │          │ 1,725 ر.س      │  │
│  │                            الإجمالي       │          │ 13,225 ر.س     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  صلاحية العرض: [30 يوم ▼]                                                  │
│                                                                             │
│  ملاحظات: [___________________________________________]                    │
│                                                                             │
│  [✓] إرسال العرض بالبريد الإلكتروني للعميل                                 │
│                                                                             │
│                           [← السابق]  [إلغاء]  [إنشاء العرض 📄]            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## المرحلة 4: صفحة إدارة عروض الأسعار

### 4.1 إنشاء صفحة `QuotesPage.tsx`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📄 عروض الأسعار                                        [+ عرض سعر جديد]  │
├─────────────────────────────────────────────────────────────────────────────┤
│  🔍 بحث...   [الحالة ▼]  [النوع ▼]  [التاريخ ▼]                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┬──────────────┬──────────────┬──────────┬──────────┬─────────┐│
│  │ الرقم    │ العميل       │ النوع        │ القيمة   │ الحالة   │ إجراءات││
│  ├──────────┼──────────────┼──────────────┼──────────┼──────────┼─────────┤│
│  │ Q-2024-01│ شركة ABC     │ اشتراك سنوي  │ 13,225   │ 🟡 مرسل  │ [...]   ││
│  │ Q-2024-02│ مؤسسة XYZ    │ منصة مخصصة   │ 45,000   │ 🟢 معتمد │ [...]   ││
│  │ Q-2024-03│ جمعية DEF    │ خدمات        │ 3,500    │ 🔵 مسودة │ [...]   ││
│  │ Q-2024-04│ شركة GHI     │ اشتراك شهري  │ 1,150    │ 🔴 منتهي│ [...]   ││
│  └──────────┴──────────────┴──────────────┴──────────┴──────────┴─────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 صفحة تفاصيل عرض السعر `QuoteDetailsPage.tsx`

- عرض تفاصيل العرض كاملة
- تحويل لـ PDF
- إرسال/إعادة إرسال بالبريد
- تحويل لعقد
- تتبع التغييرات

---

## المرحلة 5: قالب PDF احترافي

### 5.1 مكون `QuotePDFTemplate.tsx`

تصميم احترافي يحتوي على:
- شعار ويبيان
- بيانات الشركة
- بيانات العميل
- رقم العرض وتاريخه
- جدول البنود التفصيلي
- الإجمالي مع الضريبة
- الشروط والأحكام
- توقيع رقمي

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ [شعار ويبيان]                                         عرض سعر     │    │
│  │                                                     Q-2024-0001   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  من: ويبيان للحلول التقنية          إلى: شركة ABC للتقنية                  │
│  support@webyan.net                  contact@abc.com                       │
│  +966 XX XXX XXXX                    +966 XX XXX XXXX                      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  تاريخ الإصدار: 15 يناير 2024                                              │
│  صالح حتى: 14 فبراير 2024                                                  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ # │ الوصف                              │ الكمية │ السعر   │ الإجمالي │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │ 1 │ الخطة الاحترافية - اشتراك سنوي     │ 1      │ 10,000 │ 10,000   │  │
│  │ 2 │ تدريب الفريق                       │ 1      │ 500    │ 500      │  │
│  │ 3 │ تخصيص الهوية البصرية               │ 1      │ 1,000  │ 1,000    │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                   المجموع الفرعي │         │ 11,500   │  │
│  │                                   ضريبة (15%)    │         │ 1,725    │  │
│  │                                   الإجمالي       │         │ 13,225   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  الشروط والأحكام:                                                          │
│  • يعتبر هذا العرض ساريًا لمدة 30 يومًا من تاريخ الإصدار                   │
│  • الأسعار شاملة ضريبة القيمة المضافة                                      │
│  • الدفع مطلوب خلال 15 يومًا من تاريخ الفاتورة                            │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  أُعد بواسطة: أحمد محمد                                                    │
│  فريق المبيعات - ويبيان                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 مكتبة إنشاء PDF

استخدام مكتبة `@react-pdf/renderer` لإنشاء PDF من React:

```typescript
import { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';
```

---

## المرحلة 6: نظام الإرسال بالبريد

### 6.1 Edge Function `send-quote-email`

- إرسال عرض السعر كـ PDF مرفق
- رسالة احترافية بتصميم موحد
- تتبع حالة الإرسال

### 6.2 قالب بريد عرض السعر

إضافة قالب جديد في `email-templates.ts`:

```typescript
export const quoteEmailTemplate = (data: {
  clientName: string;
  quoteNumber: string;
  quoteValue: string;
  validUntil: string;
  viewUrl: string;
}) => ({
  subject: `📄 عرض سعر #${data.quoteNumber} من ويبيان`,
  html: createEmailWrapper(`
    ${createHeader('📄', 'عرض سعر جديد', 'مرفق عرض السعر الخاص بكم', COLORS.primary)}
    ...
  `)
});
```

---

## الملفات المطلوب إنشاؤها / تعديلها

### ملفات جديدة:

| الملف | الوصف |
|-------|-------|
| `src/pages/admin/PricingSettingsPage.tsx` | إدارة الخطط والخدمات |
| `src/pages/admin/crm/QuotesPage.tsx` | قائمة عروض الأسعار |
| `src/pages/admin/crm/QuoteDetailsPage.tsx` | تفاصيل عرض السعر |
| `src/components/crm/modals/AdvancedQuoteModal.tsx` | نموذج إنشاء عرض متقدم |
| `src/components/crm/quotes/QuotePDFTemplate.tsx` | قالب PDF |
| `src/components/crm/quotes/QuoteItemsTable.tsx` | جدول بنود العرض |
| `src/components/crm/quotes/PlanSelector.tsx` | اختيار الخطة |
| `src/components/crm/quotes/ServicesSelector.tsx` | اختيار الخدمات |
| `supabase/functions/send-quote-email/index.ts` | إرسال العرض بالبريد |

### ملفات للتعديل:

| الملف | التعديل |
|-------|---------|
| `src/pages/admin/AdminLayout.tsx` | إضافة روابط صفحات التسعير والعروض |
| `src/App.tsx` | تسجيل المسارات الجديدة |
| `src/lib/crm/pipelineConfig.ts` | إضافة أنواع العروض وحالاتها |
| `supabase/functions/_shared/email-templates.ts` | إضافة قالب بريد العرض |
| `src/components/crm/modals/CreateQuoteModal.tsx` | استبدال بـ AdvancedQuoteModal |

---

## ترتيب التنفيذ

### الخطوة 1: قاعدة البيانات
1. إنشاء جدول `pricing_plans`
2. إنشاء جدول `pricing_services`
3. إنشاء جدول `pricing_custom_solutions`
4. تحديث جدول `crm_quotes`

### الخطوة 2: إدارة التسعير
1. إنشاء `PricingSettingsPage.tsx`
2. إضافة للقائمة الجانبية

### الخطوة 3: نظام إنشاء العروض
1. إنشاء `AdvancedQuoteModal.tsx`
2. إنشاء مكونات الاختيار (PlanSelector, ServicesSelector)
3. استبدال CreateQuoteModal

### الخطوة 4: إدارة العروض
1. إنشاء `QuotesPage.tsx`
2. إنشاء `QuoteDetailsPage.tsx`
3. تسجيل المسارات

### الخطوة 5: PDF والإرسال
1. تثبيت `@react-pdf/renderer`
2. إنشاء `QuotePDFTemplate.tsx`
3. إنشاء Edge Function للإرسال
4. إضافة قالب البريد

---

## النتيجة المتوقعة

```
القائمة الجانبية:
────────────────────────────────────
📊 الرئيسية
  └─ لوحة التحكم

👥 إدارة العملاء
  └─ العملاء المحتملون
  └─ الفرص
  └─ عروض الأسعار         ← جديد
  └─ العملاء
  └─ مشاريع التنفيذ

⚙️ الإعدادات
  └─ إعدادات التسعير      ← جديد
  └─ ...
────────────────────────────────────
```

### تدفق العمل الجديد:

```
تحويل Lead → إنشاء Deal → إنشاء عرض سعر متقدم → إرسال PDF بالبريد → متابعة الحالة → اعتماد/رفض
                                    ↓
                        ┌─────────────────────┐
                        │ اختيار نوع البيع    │
                        │ ↓                   │
                        │ اختيار الخطة/الخدمات│
                        │ ↓                   │
                        │ معاينة الملخص       │
                        │ ↓                   │
                        │ إنشاء + إرسال PDF  │
                        └─────────────────────┘
```

---

## الفوائد

1. **توحيد التسعير** - جميع الأسعار في مكان واحد
2. **سرعة الإنشاء** - عروض أسعار في دقائق
3. **مظهر احترافي** - PDF بتصميم موحد
4. **تتبع كامل** - من الإنشاء للاعتماد
5. **قابلية التوسع** - إضافة خطط وخدمات جديدة بسهولة
