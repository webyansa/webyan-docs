

# خطة: تطوير البنود التشغيلية السنوية في عروض الأسعار

## الملخص
تحويل قسم "البنود التشغيلية السنوية" من إدخال يدوي إلى نظام مرن يعتمد على كتالوج الأسعار المركزي، مع إضافة فئة جديدة "رسوم سنوية" في إعدادات التسعير، وتطبيق سياسة ذكية للسنة الأولى حسب نوع المشروع.

---

## التغييرات المطلوبة

### 1. إضافة فئة "رسوم سنوية" في إعدادات التسعير

في جدول `pricing_services` الموجود حاليا، سنضيف خدمات جديدة بنوع `recurring_annual` وفئة مناسبة. لا حاجة لتعديل هيكل الجدول لان حقل `service_type` يدعم قيم نصية مرنة.

**الخدمات الجديدة المقترحة (بيانات افتراضية):**
- استضافة سنوية (فئة: استضافة)
- تجديد دومين (فئة: دومين)
- دعم فني سنوي (فئة: دعم)
- صيانة وتحديثات (فئة: صيانة)

### 2. تعديل صفحة إعدادات التسعير (`PricingSettingsPage.tsx`)

- إضافة تبويب رابع: **"الرسوم السنوية"** بجانب الخطط والخدمات والحلول المخصصة
- يعرض الخدمات من نوع `recurring_annual` فقط
- إمكانية إضافة/تعديل/حذف بنود سنوية (اسم، وصف، سعر سنوي، فئة)

### 3. تعديل نموذج عرض السعر (`AdvancedQuoteModal.tsx`)

**قسم البنود التشغيلية السنوية الجديد:**
- استبدال الإدخال اليدوي بقائمة منسدلة متعددة الاختيار من كتالوج "الرسوم السنوية"
- عرض البنود المحددة كبطاقات مع إمكانية تعديل المبلغ لكل بند
- لكل بند: خيار "السنة الأولى مجانية" (checkbox)
- إمكانية إضافة بند يدوي مخصص (غير موجود في الكتالوج) للمرونة

**سياسة السنة الأولى الذكية حسب نوع المشروع:**
- **اشتراك منصة**: الرسوم السنوية شاملة في سعر الاشتراك (لا تظهر كبنود منفصلة)
- **منصة مخصصة**: السنة الأولى مجانية افتراضيا، وتبدا الفوترة بعد 12 شهر
- يمكن تغيير هذا الاعداد يدويا لكل بند

### 4. استعلام البنود السنوية

- إضافة `useQuery` جديد لجلب الخدمات من نوع `recurring_annual` فقط
- عرضها في قائمة منسدلة (Dropdown/Popover) مع إمكانية تحديد اكثر من خيار

---

## التفاصيل التقنية

### بيانات افتراضية (Migration)
```sql
INSERT INTO pricing_services (name, description, service_type, price, unit, category, is_active, sort_order)
VALUES
  ('استضافة سنوية', 'استضافة سحابية عالية الاداء', 'recurring_annual', 1500, 'سنوي', 'استضافة', true, 100),
  ('تجديد دومين', 'تجديد اسم النطاق سنويا', 'recurring_annual', 150, 'سنوي', 'دومين', true, 101),
  ('دعم فني سنوي', 'دعم فني وصيانة دورية', 'recurring_annual', 2000, 'سنوي', 'دعم', true, 102),
  ('صيانة وتحديثات', 'تحديثات امنية وصيانة دورية', 'recurring_annual', 1200, 'سنوي', 'صيانة', true, 103);
```

### PricingSettingsPage.tsx
- إضافة تبويب "الرسوم السنوية" يفلتر `pricing_services` حيث `service_type = 'recurring_annual'`
- نفس منطق إضافة/تعديل/حذف الخدمات الحالي

### AdvancedQuoteModal.tsx - التغييرات الرئيسية

**State جديد:**
- استبدال `recurringItems` اليدوي بقائمة مبنية على الكتالوج
- كل عنصر يحتوي: `{ serviceId, name, amount, firstYearFree, isCustom }`

**Query جديد:**
```typescript
const { data: annualServices = [] } = useQuery({
  queryKey: ['pricing-annual-services'],
  queryFn: async () => {
    const { data } = await supabase
      .from('pricing_services')
      .select('*')
      .eq('service_type', 'recurring_annual')
      .eq('is_active', true)
      .order('sort_order');
    return data || [];
  },
  enabled: open,
});
```

**واجهة المستخدم:**
- قائمة منسدلة بالبنود السنوية المتاحة مع زر "إضافة"
- عند الاختيار: يضاف البند بسعره الافتراضي مع إمكانية التعديل
- زر "إضافة بند مخصص" للبنود غير الموجودة في الكتالوج
- لكل بند مضاف: اسم + مبلغ قابل للتعديل + خيار السنة الأولى مجانية + زر حذف

### الملفات المتاثرة
1. `supabase/migrations/` - إضافة بيانات الرسوم السنوية الافتراضية
2. `src/pages/admin/PricingSettingsPage.tsx` - تبويب الرسوم السنوية
3. `src/components/crm/modals/AdvancedQuoteModal.tsx` - قائمة منسدلة بدل الإدخال اليدوي
