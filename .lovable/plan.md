
# خطة: إضافة خيار إنشاء عرض سعر مستقل (بدون فرصة)

## الهدف
إتاحة إنشاء عروض أسعار بطريقتين:
1. **عبر فرصة بيعية** (الطريقة الحالية) - مرتبط بفرصة ويؤثر على مسار الفرصة
2. **مستقل عبر اختيار العميل** (جديد) - غير مرتبط بأي فرصة، يتم اختيار العميل مباشرة

## التغييرات المطلوبة

### 1. تعديل صفحة عروض الأسعار (`QuotesPage.tsx`)
- تغيير زر "عرض سعر جديد" ليفتح نافذة اختيار بين خيارين:
  - **عرض سعر مرتبط بفرصة**: يفتح قائمة الفرص الحالية (السلوك الموجود)
  - **عرض سعر مستقل**: يفتح قائمة العملاء لاختيار العميل مباشرة
- إضافة قائمة اختيار العملاء (من جدول `client_organizations`) مع بحث وتصفية

### 2. تعديل نافذة إنشاء عرض السعر (`AdvancedQuoteModal.tsx`)
- جعل خصائص الفرصة (`dealId`, `dealName`, `currentStage`, `currentValue`) اختيارية
- عند الإنشاء المستقل:
  - تخطي تحديث مرحلة الفرصة وسجل الانتقالات
  - تخطي إدراج نشاط الفرصة (`crm_opportunity_activities`)
  - حفظ العرض بـ `opportunity_id: null`
- عرض اسم العميل المختار بدلا من اسم الفرصة في خطوة المراجعة

### 3. تعديل تبويب المبيعات في ملف العميل (`SalesTab.tsx`)
- عروض الأسعار المستقلة ستظهر تلقائيا لأن الاستعلام يعتمد على `account_id`، لا حاجة لتعديل

---

## التفاصيل التقنية

### تعديل `QuotesPage.tsx`
- استبدال نافذة "اختر الفرصة" بنافذة تحتوي تبويبين: "عبر فرصة" و "عرض مستقل"
- في تبويب "عرض مستقل": جلب العملاء من `client_organizations` مع حقل بحث
- عند اختيار عميل: فتح `AdvancedQuoteModal` مع `accountId` و `accountName` فقط بدون `dealId`

### تعديل `AdvancedQuoteModal.tsx`
- تغيير الـ Props لتكون:
  - `accountId` (مطلوب دائما)
  - `accountName` (مطلوب دائما)
  - `dealId?` (اختياري)
  - `dealName?` (اختياري)
  - `currentStage?` (اختياري)
  - `currentValue?` (اختياري)
- في `handleSave`: التحقق من وجود `dealId` قبل تنفيذ عمليات الفرصة (تحديث المرحلة، تسجيل النشاط، تسجيل الانتقال)
- في خطوة المراجعة: عرض اسم العميل (`accountName`) بدلا من اسم الفرصة

### قاعدة البيانات
- لا تحتاج تعديل: حقل `opportunity_id` في جدول `crm_quotes` بالفعل قابل للقيمة الفارغة (`NULL`)
