

# خطة: إضافة المنطقة للبريد + إصلاح أزرار البريد جذرياً

## الملخص

ثلاث مهام:
1. عرض "المنطقة" ضمن بيانات العنوان الوطني في بريد المحاسب
2. التأكد من وجود "تحويل بنكي" في خيارات الدفع (موجود بالفعل في الكود)
3. إصلاح مشكلة أزرار البريد بشكل جذري: إرسال ملف PDF مرفق كرابط تحميل مباشر دائماً، وضمان عمل زر تأكيد الفاتورة

---

## المشكلة الحالية في الأزرار

- زر "فتح عرض السعر" يفتح رابط لوحة الإدارة التي تحتاج تسجيل دخول -- لن يعمل للمحاسب الخارجي
- زر "تأكيد إصدار الفاتورة" يفتح صفحة `/invoice-confirm/:id` التي تحتاج نشر التطبيق على `webyan.sa`
- الحل: استبدال زر "فتح عرض السعر" بـ رابط تحميل PDF مباشر دائماً، وضمان إنشاء الـ PDF قبل الإرسال

---

## التعديلات المطلوبة

### 1. إضافة المنطقة في بريد المحاسب

**الملف:** `supabase/functions/send-invoice-request/index.ts`

إضافة صف "المنطقة" في جدول العنوان الوطني بالبريد مع تحويل القيمة الإنجليزية إلى الاسم العربي:

```text
المدينة: الرياض
المنطقة: منطقة الرياض    <-- جديد
الحي: العليا
...
```

سيتم إضافة كائن mapping للمناطق داخل الـ Edge Function:

```typescript
const regionLabels: Record<string, string> = {
  riyadh: 'منطقة الرياض',
  makkah: 'منطقة مكة المكرمة',
  // ... باقي المناطق
};
```

### 2. إصلاح أزرار البريد

**الملف:** `supabase/functions/send-invoice-request/index.ts`

- جعل زر "تحميل عرض السعر PDF" يظهر دائماً عندما يتوفر `quote_pdf_url` (هذا يعمل حالياً)
- إزالة الخيار البديل الذي يفتح لوحة الإدارة (حذف رابط `/admin/crm/quotes/...`) لأن المحاسب لا يملك وصولاً
- إذا لم يتوفر PDF، لا يظهر زر عرض السعر بدلاً من إظهار رابط لا يعمل

**الملف:** `src/components/crm/modals/InvoiceRequestModal.tsx`

- التأكد من أن إنشاء PDF يتم بشكل صحيح وأن `quote_pdf_url` يُمرر دائماً للـ Edge Function
- إضافة معالجة خطأ أفضل في حال فشل رفع الـ PDF مع إبلاغ المستخدم

### 3. ملاحظة حول "تحويل بنكي"

خيار "تحويل بنكي" (`bank_transfer`) موجود بالفعل في القائمة المنسدلة في الكود (السطر 488). لا يحتاج تعديلاً.

---

## التفاصيل التقنية

### الملفات المتأثرة

| الملف | التعديل |
|---|---|
| `supabase/functions/send-invoice-request/index.ts` | إضافة المنطقة بالعنوان الوطني + إصلاح منطق الأزرار |
| `src/components/crm/modals/InvoiceRequestModal.tsx` | تحسين معالجة أخطاء رفع PDF |

### النشر

- إعادة نشر Edge Function: `send-invoice-request`
- **مهم**: زر "تأكيد إصدار الفاتورة" يعمل فقط بعد نشر التطبيق على `webyan.sa` -- يجب النشر (Publish) من Lovable لتفعيله

