

# إعادة بناء نظام CRM المبسط لمنصة ويبيان

---

## تحليل الوضع الحالي

### المشاكل الموجودة:
1. **أخطاء بناء** في ملفات `SalesPipelinePage.tsx` و `DeliveryPipelinePage.tsx` (تكرار كود)
2. **تعقيد زائد** في النظام الحالي (9 مراحل للـ Leads، 6 مراحل للـ Opportunities، 9 مراحل للـ Implementation)
3. **تشابك المفاهيم** بين العملاء المحتملين والفرص والعملاء
4. **صفحات CRM غير مسجلة** في Router أو القائمة الجانبية

### الجداول الموجودة حاليًا:
- `crm_leads` (27 عمود - معقد)
- `crm_opportunities` (21 عمود)
- `crm_quotes`
- `crm_contracts`
- `crm_implementations`
- `crm_systems`
- `crm_stage_transitions`
- `client_organizations` (العملاء الرسميون)
- `client_accounts` (جهات الاتصال)
- `client_invoices` / `client_payments`

---

## الخطة: نظام CRM مبسط بثلاث وحدات واضحة

### الهيكل الجديد:

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                         نظام CRM المبسط لويبيان                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │  العملاء   │──────▶│   الفرص    │──────▶│   العملاء   │               │
│  │ المحتملون  │ تحويل │  (Deals)   │ اعتماد │  (Accounts) │               │
│  │  (Leads)   │       │            │       │             │               │
│  └─────────────┘       └─────────────┘       └─────────────┘               │
│        │                     │                     │                       │
│        │                     │                     │                       │
│   بيانات بسيطة          Kanban Board          ملف 360°                    │
│   + تغيير الحالة        + تغيير المرحلة      + تبويبات كاملة               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## المرحلة 1: إصلاح الأخطاء + تحديث القائمة الجانبية

### 1.1 إصلاح أخطاء البناء
- إزالة الكود المكرر في نهاية `SalesPipelinePage.tsx` (سطر 428-431)
- إزالة الكود المكرر في نهاية `DeliveryPipelinePage.tsx` (سطر 444-446)

### 1.2 تحديث القائمة الجانبية (`AdminLayout.tsx`)
إضافة قسم CRM جديد:

```typescript
const crmSection: NavSection = {
  title: 'إدارة العملاء',
  sectionPermission: 'canManageClients',
  items: [
    { title: 'العملاء المحتملون', href: '/admin/crm/leads', icon: UserPlus },
    { title: 'الفرص', href: '/admin/crm/deals', icon: Target },
    { title: 'العملاء', href: '/admin/clients', icon: Building2 },
    { title: 'مشاريع التنفيذ', href: '/admin/crm/delivery', icon: Rocket },
  ]
};
```

### 1.3 تسجيل المسارات في `App.tsx`
```typescript
// CRM Routes
<Route path="crm/leads" element={<LeadsPage />} />
<Route path="crm/deals" element={<DealsPage />} />
<Route path="crm/delivery" element={<DeliveryPipelinePage />} />
```

---

## المرحلة 2: صفحة العملاء المحتملين (Leads)

### 2.1 صفحة `LeadsPage.tsx` - واجهة بسيطة

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  👥 العملاء المحتملون                               [+ عميل محتمل جديد]    │
├─────────────────────────────────────────────────────────────────────────────┤
│  🔍 بحث...    [الحالة ▼]  [المصدر ▼]  [المسؤول ▼]                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────┬────────────────┬──────────────┬────────────┬───────────────┐ │
│  │ اسم الجهة │  جهة الاتصال  │    الحالة    │   المصدر  │   إجراءات    │ │
│  ├───────────┼────────────────┼──────────────┼────────────┼───────────────┤ │
│  │ شركة ABC  │ أحمد محمد     │ 🔵 جديد      │ نموذج     │ [تحويل][حذف] │ │
│  │           │ ahmed@abc.com │              │            │               │ │
│  ├───────────┼────────────────┼──────────────┼────────────┼───────────────┤ │
│  │ مؤسسة XYZ │ سارة أحمد     │ 🟢 مهتم      │ إحالة     │ [تحويل][حذف] │ │
│  │           │ sara@xyz.sa   │              │            │               │ │
│  └───────────┴────────────────┴──────────────┴────────────┴───────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 حالات العملاء المحتملين (4 حالات فقط):

| الحالة | اللون | الوصف |
|--------|-------|-------|
| `new` | 🔵 أزرق | عميل جديد لم يتم التواصل معه |
| `contacted` | 🟡 أصفر | تم التواصل - بانتظار الرد |
| `interested` | 🟢 أخضر | مهتم - جاهز للتحويل لفرصة |
| `not_interested` | ⚫ رمادي | غير مهتم |

### 2.3 نموذج إضافة عميل محتمل (حقول بسيطة):
- اسم الجهة *
- اسم جهة الاتصال *
- البريد الإلكتروني *
- الهاتف
- مصدر العميل (نموذج / اتصال / إحالة)
- ملاحظات

### 2.4 زر "تحويل لفرصة":
- نافذة حوار بسيطة لإدخال:
  - اسم الفرصة
  - نوع الخدمة (اشتراك ويبيان / منصة مخصصة)
  - القيمة المتوقعة
- عند التحويل:
  - إنشاء سجل في `crm_opportunities`
  - تحديث `is_converted = true` في Lead
  - تسجيل الحدث في Timeline

---

## المرحلة 3: صفحة الفرص (Deals) - Kanban Board

### 3.1 صفحة `DealsPage.tsx` - لوحة كانبان

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  🎯 الفرص                                                  [+ فرصة جديدة]  │
├─────────────────────────────────────────────────────────────────────────────┤
│  🔍 بحث...    [نوع الخدمة ▼]  [المسؤول ▼]                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐│
│  │فرصة جديدة│ │اجتماع تم │ │عرض مرسل │ │بانتظار   │ │ معتمد   │ │مرفوض  ││
│  │   3     │ │    2    │ │    4    │ │الاعتماد  │ │    5    │ │   2   ││
│  │ 45,000  │ │ 30,000  │ │ 120,000 │ │  80,000  │ │ 200,000 │ │25,000 ││
│  ├──────────┤ ├──────────┤ ├──────────┤ ├──────────┤ ├──────────┤ ├────────┤│
│  │┌────────┐│ │┌────────┐│ │┌────────┐│ │┌────────┐│ │          │ │        ││
│  ││شركة A ││ ││مؤسسة B ││ ││جمعية C ││ ││شركة D ││ │          │ │        ││
│  ││────────││ ││────────││ ││────────││ ││────────││ │          │ │        ││
│  ││💰15,000││ ││💰20,000││ ││💰50,000││ ││💰40,000││ │          │ │        ││
│  ││📦اشتراك││ ││🔧منصة  ││ ││📦اشتراك││ ││📦اشتراك││ │          │ │        ││
│  │└────────┘│ │└────────┘│ │└────────┘│ │└────────┘│ │          │ │        ││
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 مراحل الفرص (6 مراحل):

| المرحلة | الوصف |
|---------|-------|
| `new_opportunity` | فرصة جديدة - بانتظار التواصل |
| `meeting_done` | تم الاجتماع مع العميل |
| `proposal_sent` | تم إرسال عرض السعر |
| `pending_approval` | بانتظار اعتماد العميل |
| `approved` | تم الاعتماد ✓ |
| `rejected` | مرفوض ✗ |

### 3.3 عند الاعتماد (`approved`):
**إنشاء عميل رسمي تلقائيًا:**
1. إنشاء سجل في `client_organizations` من بيانات الفرصة
2. تحديث `status = 'won'` في الفرصة
3. ربط الفرصة بالـ Account الجديد
4. تسجيل في Timeline
5. إظهار Toast: "تم إنشاء ملف العميل بنجاح - [فتح الملف]"

---

## المرحلة 4: تحديث صفحة العملاء (Accounts)

### 4.1 تحديث `ClientsPage.tsx`
- إخفاء زر "إضافة مؤسسة" (العملاء يُنشأون تلقائيًا من الفرص المعتمدة)
- إضافة مؤشر المصدر (من أي فرصة)
- ترتيب حسب آخر تفاعل أو تاريخ الإنشاء

### 4.2 تبويبات ملف العميل 360° (مبسطة):

| التبويب | المحتوى |
|---------|---------|
| **ملخص** | حالة العميل + آخر نشاط + تنبيهات |
| **بيانات الجهة** | اسم + نوع + بيانات التواصل |
| **الاشتراك** | الباقة + المدة + حالة التجديد |
| **التنفيذ** | مشروع التنفيذ (إن وجد) + التقدم |
| **الاجتماعات** | قائمة الاجتماعات السابقة والقادمة |
| **التذاكر** | تذاكر الدعم المفتوحة والمغلقة |
| **الفواتير** | الفواتير + المدفوعات |

---

## الملفات المطلوب إنشاؤها / تعديلها

### ملفات جديدة:
| الملف | الوصف |
|-------|-------|
| `src/pages/admin/crm/LeadsPage.tsx` | صفحة العملاء المحتملين |
| `src/pages/admin/crm/DealsPage.tsx` | صفحة الفرص (Kanban) |
| `src/components/crm/LeadForm.tsx` | نموذج إضافة/تعديل عميل محتمل |
| `src/components/crm/ConvertToDealModal.tsx` | نافذة تحويل لفرصة |
| `src/components/crm/DealCard.tsx` | بطاقة الفرصة في Kanban |
| `src/components/crm/ApprovalModal.tsx` | نافذة اعتماد الفرصة |

### ملفات للتعديل:
| الملف | التعديل |
|-------|---------|
| `src/pages/admin/crm/SalesPipelinePage.tsx` | إصلاح خطأ البناء (إزالة التكرار) |
| `src/pages/admin/crm/DeliveryPipelinePage.tsx` | إصلاح خطأ البناء (إزالة التكرار) |
| `src/pages/admin/AdminLayout.tsx` | إضافة قسم CRM في القائمة الجانبية |
| `src/App.tsx` | تسجيل المسارات الجديدة |
| `src/lib/crm/pipelineConfig.ts` | تبسيط مراحل الـ Leads (4 بدلًا من 9) |
| `src/pages/admin/ClientsPage.tsx` | إخفاء زر الإضافة اليدوية |

---

## تبسيط إعدادات Pipeline

### تحديث `pipelineConfig.ts`:

```typescript
// مراحل العملاء المحتملين (4 فقط)
export type LeadStatus = 'new' | 'contacted' | 'interested' | 'not_interested';

export const leadStatuses: Record<LeadStatus, {...}> = {
  new: { label: 'جديد', color: 'blue', icon: UserPlus },
  contacted: { label: 'تم التواصل', color: 'yellow', icon: Phone },
  interested: { label: 'مهتم', color: 'green', icon: ThumbsUp },
  not_interested: { label: 'غير مهتم', color: 'gray', icon: X },
};

// مراحل الفرص (6 فقط)
export type DealStage = 
  | 'new_opportunity' 
  | 'meeting_done' 
  | 'proposal_sent' 
  | 'pending_approval' 
  | 'approved' 
  | 'rejected';

export const dealStages: Record<DealStage, {...}> = {
  new_opportunity: { label: 'فرصة جديدة', order: 1 },
  meeting_done: { label: 'اجتماع تم', order: 2 },
  proposal_sent: { label: 'عرض مرسل', order: 3 },
  pending_approval: { label: 'بانتظار الاعتماد', order: 4 },
  approved: { label: 'معتمد', order: 5 },
  rejected: { label: 'مرفوض', order: 6 },
};
```

---

## ترتيب التنفيذ

### الخطوة 1: إصلاح الأخطاء العاجلة
1. إصلاح `SalesPipelinePage.tsx`
2. إصلاح `DeliveryPipelinePage.tsx`

### الخطوة 2: تحديث الهيكل
1. تحديث `AdminLayout.tsx` بقسم CRM
2. تحديث `App.tsx` بالمسارات الجديدة
3. تبسيط `pipelineConfig.ts`

### الخطوة 3: بناء الصفحات
1. إنشاء `LeadsPage.tsx`
2. إنشاء `DealsPage.tsx`
3. إنشاء المكونات المساعدة

### الخطوة 4: الربط والأتمتة
1. دالة تحويل Lead إلى Deal
2. دالة اعتماد Deal وإنشاء Account
3. تسجيل الأحداث في Timeline

---

## النتيجة المتوقعة

```text
القائمة الجانبية الجديدة:
────────────────────────
📊 الرئيسية
  └─ لوحة التحكم
  └─ التقارير

👥 إدارة العملاء          ← قسم جديد
  └─ العملاء المحتملون    ← صفحة Leads
  └─ الفرص                ← صفحة Deals (Kanban)
  └─ العملاء              ← صفحة Accounts
  └─ مشاريع التنفيذ       ← صفحة Delivery

💬 المحادثات
  └─ ...

🎫 تذاكر الدعم
  └─ ...
────────────────────────
```

هذا التصميم يوفر:
- **وضوح**: 3 وحدات منفصلة بوظائف محددة
- **بساطة**: حقول قليلة ومراحل واضحة
- **تدفق منطقي**: Lead → Deal → Account
- **قابلية التوسع**: سهولة إضافة ميزات مستقبلًا

