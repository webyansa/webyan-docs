

# خطة: تطوير نظام الضريبة والتسعير وعروض الأسعار

## الملخص
إضافة إعداد مركزي لنسبة ضريبة القيمة المضافة (VAT)، تحويل أسعار الكتالوج إلى "شامل الضريبة" مع عرض التفاصيل تلقائيا، تطوير حساب الخصم السنوي للاشتراكات، وإضافة خيار "شامل/غير شامل" في عروض الأسعار مع ملخص مالي احترافي.

---

## 1. إعداد نسبة الضريبة المركزية (VAT Settings)

**الوضع الحالي:** نسبة الضريبة مكتوبة كثابت `const TAX_RATE = 15` في كود عرض السعر.

**التغيير:**
- إضافة سجل في جدول `system_settings` بمفتاح `vat_rate` وقيمة `15`
- إنشاء قسم "إعدادات الضريبة" في صفحة التسعير (`PricingSettingsPage.tsx`) يسمح بتغيير النسبة
- استبدال الثابت `TAX_RATE` باستعلام يجلب النسبة من `system_settings`
- استخدام هذه النسبة في كل الأماكن: التسعير، عروض الأسعار، صفحة تفاصيل العرض

## 2. التسعير شامل الضريبة مع التفاصيل

**الوضع الحالي:** الأسعار المدخلة لا تحدد إن كانت شاملة أم لا.

**التغيير في شاشات إدارة التسعير:**
- جعل حقل السعر يكون "شامل الضريبة" مع تسمية واضحة
- أسفل حقل السعر، عرض تلقائي ثلاثي:
  - السعر قبل الضريبة = السعر الشامل / (1 + نسبة الضريبة/100)
  - قيمة الضريبة = السعر الشامل - السعر قبل الضريبة
  - السعر شامل الضريبة (المدخل)
- تطبيق هذا على: نموذج الخطط، نموذج الخدمات، نموذج الرسوم السنوية، الحلول المخصصة

## 3. تطوير أسعار الاشتراكات (الخصم السنوي)

**الوضع الحالي:** السعر الشهري والسنوي يُدخلان يدويا مع خصم ثابت.

**التغيير:**
- حقل الإدخال الأساسي: السعر الشهري (شامل الضريبة)
- الحساب التلقائي: السعر السنوي = الشهري x 12
- خيار تفعيل "خصم سنوي" مع نسبة %
- عرض تلقائي:
  - السعر السنوي قبل الخصم
  - قيمة الخصم
  - السعر السنوي بعد الخصم
- السعر السنوي `yearly_price` في قاعدة البيانات يصبح محسوبا تلقائيا (يمكن تعديله يدويا)
- إظهار التفاصيل الضريبية لكل من الشهري والسنوي

## 4. خيار "شامل/غير شامل الضريبة" في عرض السعر

**التغيير في `AdvancedQuoteModal.tsx`:**
- إضافة خيار (Radio) في خطوة المراجعة: "الأسعار شاملة الضريبة" / "الأسعار غير شاملة الضريبة"
- حفظ هذا الخيار في حقل جديد `tax_inclusive` (boolean) في جدول `crm_quotes`

**عند "غير شامل الضريبة":**
- الملخص يعرض: الإجمالي الفرعي (بدون ضريبة) + سطر الضريبة + الإجمالي شامل الضريبة
- البنود تعرض أسعارها بدون ضريبة

**عند "شامل الضريبة":**
- الملخص يعرض: الإجمالي شامل الضريبة
- الضريبة تظهر كمعلومة توضيحية مع كلمة "شامل"
- البنود تعرض أسعارها شاملة الضريبة

## 5. تحديث صفحة عرض السعر (QuoteDetailsPage)

- قراءة حقل `tax_inclusive` من العرض
- عرض الجدول والملخص المالي بحسب الخيار المحدد
- إضافة شارة واضحة تبين حالة الضريبة
- تحسين التنسيق المحاسبي في الملخص النهائي

---

## التفاصيل التقنية

### Migration SQL
```sql
-- Add VAT rate to system settings
INSERT INTO system_settings (key, value, description)
VALUES ('vat_rate', '15', 'نسبة ضريبة القيمة المضافة')
ON CONFLICT (key) DO NOTHING;

-- Add tax_inclusive flag to quotes
ALTER TABLE crm_quotes ADD COLUMN IF NOT EXISTS tax_inclusive boolean DEFAULT false;
```

### الملفات المتأثرة

1. **`supabase/migrations/`** - إضافة إعداد الضريبة وعمود `tax_inclusive`
2. **`src/pages/admin/PricingSettingsPage.tsx`** - قسم إعدادات الضريبة + تفاصيل الأسعار الشاملة + تطوير نموذج الخطط
3. **`src/components/crm/modals/AdvancedQuoteModal.tsx`** - جلب نسبة الضريبة ديناميكيا + خيار شامل/غير شامل + حسابات متوافقة
4. **`src/pages/admin/crm/QuoteDetailsPage.tsx`** - عرض الملخص المالي حسب خيار الضريبة
5. **`src/components/crm/quotes/QuoteItemsTable.tsx`** - دعم عرض الأسعار بالوضعين (شامل/غير شامل)
6. **`src/lib/crm/pipelineConfig.ts`** - تحديث `formatCurrency` لدعم منزلتين عشريتين

### منطق الحسابات

**حساب السعر قبل الضريبة من الشامل:**
```typescript
const priceBeforeTax = +(priceInclTax / (1 + vatRate / 100)).toFixed(2);
const taxValue = +(priceInclTax - priceBeforeTax).toFixed(2);
```

**حساب السعر السنوي بالخصم:**
```typescript
const yearlyBase = monthlyPrice * 12;
const discountAmount = +(yearlyBase * discountPercent / 100).toFixed(2);
const yearlyAfterDiscount = +(yearlyBase - discountAmount).toFixed(2);
```

**خيار الضريبة في العرض:**
- `tax_inclusive = true`: الأسعار المعروضة شاملة، الضريبة توضيحية
- `tax_inclusive = false`: الأسعار بدون ضريبة، الضريبة تُضاف كسطر منفصل، الإجمالي = فرعي + ضريبة

